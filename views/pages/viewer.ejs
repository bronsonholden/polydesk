<div id="wrapper" class="container-fluid">
  <div class="row">
    <div id="properties" class="col-md-3 cold-lg-3">
      <form id="metadata" method="POST" action="/viewer/<%- id -%>/metadata" enctype="multipart/form-data">
        <%
        var orderedMetadataSets = Object.keys(metadataSets).sort(function (a, b) {
          if (typeof(metadataSets[a].order) === 'number' && typeof(metadataSets[b].order) !== 'number') {
            return -1;
          } else if (typeof(metadataSets[a].order) !== 'number' && typeof(metadataSets[b].order) === 'number') {
            return 1;
          } else if (typeof(metadataSets[a].order) !== 'number' && typeof(metadataSets[b].order) !== 'number') {
            return 0;
          }
          return metadataSets[a].order - metadataSets[b].order;
        });
        orderedMetadataSets.forEach(function (setName, setOrder) {
          var set = metadataSets[setName].fields;
        %>
          <div class="mt-3"></div>
          <div class="metadata-set" setname="<%- setName -%>" setorder="<%- setOrder -%>">
            <div class="btn-group">
              <button class="btn btn-light btn-lg" type="button">
                <%- setName -%>
              </button>
              <button class="btn btn-light btn-lg metadata-set-unlock" type="button">
                <i class="ion-unlocked"></i>
              </button>
              <button class="btn btn-light btn-lg metadata-set-lock hidden" type="button">
                <i class="ion-locked"></i>
              </button>
            </div>
            <hr>
            <%
            var orderedFields = Object.keys(set).sort(function (a, b) {
              if (typeof(set[a].order) === 'number' && typeof(set[b].order) !== 'number') {
                return -1;
              } else if (typeof(set[a].order) !== 'number' && typeof(set[b].order) === 'number') {
                return 1;
              } else if (typeof(set[a].order) !== 'number' && typeof(set[b].order) !== 'number') {
                return 0;
              }
              return set[a].order - set[b].order;
            });
            orderedFields.forEach(function (key) {
            %>
              <div class="form-group">
                <label><h6><%- key -%></h6></label>
                <%
                var value = set[key].value;
                var typeString;

                switch (set[key].type) {
                case 'N':
                  typeString = 'Number';
                  break;
                case 'P':
                  typeString = 'Precision';
                  break;
                case 'S':
                  typeString = 'String';
                  break;
                case 'B':
                  typeString = 'Boolean';
                  break;
                case 'F':
                  typeString = 'Formula';
                  value = set[key].err || set[key].calculated;
                  break;
                default:
                  break;
                }

                if (set[key].type.length === 2 && set[key].type[1] === 'L') {
                  value.forEach(function (val, idx, arr) {
                %>
                  <div class="input-group mb-3 locked">
                    <input class="form-control" fieldtype="<%- set[key].type -%>" fieldorder="<%- set[key].order -%>" setname="<%- setName -%>" fieldname="<%- key -%>" type="string" value="<%- val -%>"></input>
                  </div>
                  <div class="input-group mb-3 unlocked hidden">
                    <div class="input-group-prepend">
                      <button class="btn btn-outline-secondary" type="button"><i class="icon ion-chevron-up"></i></button>
                      <button class="btn btn-outline-secondary" type="button"><i class="icon ion-chevron-down"></i></button>
                    </div>
                    <input class="form-control" fieldtype="<%- set[key].type -%>" fieldorder="<%- set[key].order -%>" setname="<%- setName -%>" fieldname="<%- key -%>" type="string" value="<%- val -%>"></input>
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" type="button"><i class="icon ion-close"></i></button>
                    </div>
                  </div>
                <%
                  });
                } else {
                %>
                  <div class="input-group mb-3 locked">
                    <% if (set[key].type === 'F') { %>
                      <input disabled="disabled" class="form-control" fieldtype="<%- set[key].type -%>" fieldorder="<%- set[key].order -%>" setname="<%- setName -%>" fieldname="<%- key -%>" type="string" value="<%- value -%>" formula="<%- encodeURI(set[key].value) -%>"></input>
                    <% } else { %>
                      <input class="form-control" fieldtype="<%- set[key].type -%>" fieldorder="<%- set[key].order -%>" setname="<%- setName -%>" fieldname="<%- key -%>" type="string" value="<%- value -%>"></input>
                    <% } %>
                  </div>
                  <div class="input-group mb-3 unlocked hidden">
                    <div class="input-group-prepend">
                      <button class="btn btn-outline-secondary" type="button"><i class="icon ion-chevron-up"></i></button>
                      <button class="btn btn-outline-secondary" type="button"><i class="icon ion-chevron-down"></i></button>
                    </div>
                    <% if (set[key].type === 'F') { %>
                      <input class="form-control" fieldtype="<%- set[key].type -%>" fieldorder="<%- set[key].order -%>" setname="<%- setName -%>" fieldname="<%- key -%>" type="string" value="<%- set[key].value.replace(/"/g, '&quot;') -%>" formula="<%- encodeURI(set[key].value) -%>"></input>
                    <% } else { %>
                      <input disabled="disabled" class="form-control" fieldtype="<%- set[key].type -%>" fieldorder="<%- set[key].order -%>" setname="<%- setName -%>" fieldname="<%- key -%>" type="string" value="<%- value -%>"></input>
                    <% } %>
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" type="button"><i class="icon ion-close"></i></button>
                      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><%- typeString -%></button>
                      <div class="dropdown-menu">
                        <a class="dropdown-item" href="#">String</a>
                        <a class="dropdown-item" href="#">Number</a>
                        <a class="dropdown-item" href="#">Boolean</a>
                        <a class="dropdown-item" href="#">Precision</a>
                        <a class="dropdown-item" href="#">Formula</a>
                      </div>
                    </div>
                  </div>
              <%
              }
              %>
              </div>
              <div class="mt-4"></div>
            <%
            });
            %>
          </div>
        <%
        });
        %>
        <div style="height:300px;">&nbsp;</div>
      </form>
    </div>
    <div id="viewer" class="pdf-viewer offset-md-3 offset-lg-3 col-md-9 col-lg-9" data-url="<%- documentUrl -%>">
      <div id="search" class="modal" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Search</h5>
            </div>
            <div class="modal-body">
              <input id="search-input" type="text" placeholder="Enter your search text"></input>
            </div>
            <div class="modal-footer">
              <button id="search-next-result" type="button" class="btn">Next</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  $(document).ready(function () {
    $(document).on('click', '.metadata-set-unlock', function () {
      $(this).siblings('.metadata-set-lock').removeClass('hidden');
      $(this).addClass('hidden');
      $(this).closest('.metadata-set').find('.unlocked').removeClass('hidden');
      $(this).closest('.metadata-set').find('.locked').addClass('hidden');
    });

    $(document).on('click', '.metadata-set-lock', function () {
      $(this).siblings('.metadata-set-unlock').removeClass('hidden');
      $(this).addClass('hidden');
      $(this).closest('.metadata-set').find('.locked').removeClass('hidden');
      $(this).closest('.metadata-set').find('.unlocked').addClass('hidden');
    });
  });
</script>
